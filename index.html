<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>Sistema de Ferramentas Mobile</title>
    
    <!-- CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        /* ESTILOS MANTIDOS DO C√ìDIGO ANTERIOR */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            background-color: #f5f7fa;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        
        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .login-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 16px;
            padding: 30px 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .mobile-dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        
        .mobile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top, 0));
            color: white;
        }
        
        .mobile-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 70px;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0));
            z-index: 100;
        }
        
        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            padding: 8px 5px;
            color: var(--gray-color);
            font-size: 11px;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: var(--secondary-color);
        }
        
        .tab-button i {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background: var(--success-color);
        }
        
        .notification.error {
            background: var(--danger-color);
        }
        
        .notification.warning {
            background: var(--warning-color);
        }
        
        .storage-warning {
            background: var(--warning-color);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }
        
        .storage-warning.show {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .mobile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .mobile-btn-primary {
            background: var(--secondary-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 24px; margin-bottom: 10px;">Sistema de Ferramentas</h1>
                    <p style="opacity: 0.9;">Login Mobile</p>
                </div>
                
                <div id="loginError" class="notification error" style="display: none; position: relative; top: 0; transform: none; opacity: 1; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i> Credenciais inv√°lidas
                </div>
                
                <div class="form-group">
                    <label for="loginEmail">Email ou Usu√°rio</label>
                    <input type="text" id="loginEmail" placeholder="fabio@fwcompany.com.br" autocapitalize="off" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha" autocomplete="current-password">
                </div>
                
                <button type="button" class="mobile-btn mobile-btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                
                <div style="margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <p style="text-align: center; font-size: 14px; margin-bottom: 10px;">Credenciais de teste:</p>
                    <div style="font-size: 12px;">
                        <p><strong>DEV:</strong> fabio@fwcompany.com.br</p>
                        <p><strong>Senha:</strong> FabioFW123@</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Mobile -->
        <div id="mobileDashboard" class="mobile-dashboard">
            <!-- Header -->
            <header class="mobile-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h1 style="font-size: 18px; font-weight: bold;">Sistema de Ferramentas</h1>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <span id="userBadge" style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">DEV</span>
                            <span id="connectionStatus" style="background: rgba(231,76,60,0.2); color: #e74c3c; padding: 4px 10px; border-radius: 12px; font-size: 12px;">Offline</span>
                        </div>
                    </div>
                    <button id="menuBtn" style="background: rgba(255,255,255,0.2); border: none; width: 44px; height: 44px; border-radius: 50%; color: white; font-size: 20px;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                
                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Itens</div>
                        <div style="font-size: 20px; font-weight: bold;" id="totalItems">0/0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Valor</div>
                        <div style="font-size: 20px; font-weight: bold;" id="totalValue">R$ 0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Status</div>
                        <div style="font-size: 20px; font-weight: bold;" id="syncStatus">Local</div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="mobile-content">
                <!-- Storage Warning -->
                <div id="storageWarning" class="storage-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <span id="storageWarningText">Armazenamento local limitado</span>
                </div>
                
                <!-- Dashboard Tab -->
                <div id="tabDashboard" class="tab-content active">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Dashboard</h2>
                    
                    <!-- Card de Controle de Sincroniza√ß√£o (NOVO) -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Controle de Sincroniza√ß√£o</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <button id="syncAllBtn" class="mobile-btn" style="background: #8e44ad; color: white;">
                                <i class="fas fa-database"></i> Buscar Tudo
                            </button>
                            <button id="syncUpdatesBtn" class="mobile-btn" style="background: #3498db; color: white;">
                                <i class="fas fa-sync"></i> S√≥ Atualiza√ß√µes
                            </button>
                        </div>
                        <div style="font-size: 12px; color: var(--gray-color); text-align: center;">
                            <span id="syncInfo">√öltima sincroniza√ß√£o: Nunca</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-pie" style="color: var(--secondary-color);"></i>
                            Status dos Itens
                        </h3>
                        <div id="statusStats">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Carregando...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">A√ß√µes R√°pidas</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button class="mobile-btn" id="addItemBtn" style="background: var(--secondary-color); color: white;">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button class="mobile-btn" id="syncNowBtn" style="background: var(--success-color); color: white;">
                                <i class="fas fa-sync-alt"></i> Sincronizar
                            </button>
                            <button class="mobile-btn" id="clearCacheBtn" style="background: var(--warning-color); color: white; grid-column: span 2;">
                                <i class="fas fa-trash-alt"></i> Limpar Cache
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Itens Recentes</h3>
                            <button id="viewAllBtn" style="background: none; border: none; color: var(--secondary-color); font-size: 14px;">
                                Ver Todos
                            </button>
                        </div>
                        <div id="recentItems">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhum item cadastrado</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cat√°logo Tab -->
                <div id="tabCatalogo" class="tab-content" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1; position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray-color);"></i>
                            <input type="text" id="searchInput" placeholder="Buscar..." style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 16px;">
                        </div>
                        <button id="filterBtn" style="background: var(--light-color); border: none; width: 50px; border-radius: 10px;">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color); text-align: center;">
                        <span id="toolsCount">0 de 0 itens carregados</span>
                        <button id="loadMoreBtn" style="background: none; border: none; color: var(--secondary-color); font-size: 14px; margin-left: 10px; display: none;">
                            Carregar mais
                        </button>
                    </div>
                    
                    <div id="toolsList">
                        <!-- Lista ser√° carregada dinamicamente -->
                    </div>
                </div>
                
                <!-- Loader -->
                <div id="loader" class="loader"></div>
            </div>
            
            <!-- Footer Tabs -->
            <footer class="mobile-footer">
                <button class="tab-button active" data-tab="dashboard">
                    <i class="fas fa-home"></i>
                    <span>In√≠cio</span>
                </button>
                <button class="tab-button" data-tab="catalogo">
                    <i class="fas fa-list"></i>
                    <span>Itens</span>
                </button>
                <button class="tab-button" data-tab="scanner">
                    <i class="fas fa-qrcode"></i>
                    <span>Scanner</span>
                </button>
                <button class="tab-button" data-tab="config">
                    <i class="fas fa-cog"></i>
                    <span>Config</span>
                </button>
            </footer>
        </div>
        
        <!-- Notification Toast -->
        <div id="notification" class="notification">
            <div id="notificationContent"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO SUPABASE FIXA
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://azlgjkjzitbolyfyyaip.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6bGdqa2p6aXRib2x5Znl5YWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTQ1NjcsImV4cCI6MjA4MTk5MDU2N30.PefjFNb5Phq2ZkR26-RlJdb-pnFUbYp1PxjYwI1LUpA'
        };

        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let currentUser = null;
        let tools = [];
        let supabaseClient = null;
        let isOnline = navigator.onLine;
        let currentTab = 'dashboard';
        let db = null;
        let loadedToolsCount = 0;
        let totalToolsInDB = 0;

        // ============================================
        // INDEXEDDB - Substitui localStorage
        // ============================================
        const DB_NAME = 'FerramentasDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'tools';

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject('IndexedDB n√£o suportado');
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('‚ùå Erro ao abrir IndexedDB:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ IndexedDB inicializado');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id'
                        });
                        
                        store.createIndex('code', 'code', { unique: true });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('status', 'status', { unique: false });
                        store.createIndex('updatedAt', 'updatedAt', { unique: false });
                    }
                };
            });
        }

        function saveToIndexedDB(data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB n√£o inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    let successCount = 0;
                    
                    const insertNext = (index) => {
                        if (index >= data.length) {
                            console.log(`‚úÖ ${successCount} itens salvos no IndexedDB`);
                            resolve(successCount);
                            return;
                        }
                        
                        const item = data[index];
                        const request = store.add(item);
                        
                        request.onsuccess = () => {
                            successCount++;
                            insertNext(index + 1);
                        };
                        
                        request.onerror = () => {
                            console.error(`‚ùå Erro ao salvar item ${index}`);
                            insertNext(index + 1);
                        };
                    };
                    
                    insertNext(0);
                };
                
                clearRequest.onerror = (event) => {
                    reject('Erro ao limpar dados: ' + event.target.error);
                };
            });
        }

        function loadFromIndexedDB(limit = 100) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB n√£o inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('updatedAt');
                
                const request = index.openCursor(null, 'prev');
                const results = [];
                let count = 0;

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    
                    if (cursor && count < limit) {
                        results.push(cursor.value);
                        count++;
                        cursor.continue();
                    } else {
                        console.log(`üìÇ ${results.length} itens carregados do IndexedDB`);
                        resolve(results);
                    }
                };

                request.onerror = (event) => {
                    reject('Erro ao carregar dados: ' + event.target.error);
                };
            });
        }

        async function checkStorageUsage() {
            if (!navigator.storage || !navigator.storage.estimate) {
                return null;
            }

            try {
                const estimate = await navigator.storage.estimate();
                const usageMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
                const percentage = ((estimate.usage / estimate.quota) * 100).toFixed(1);
                
                console.log(`üíæ Uso: ${usageMB}MB de ${quotaMB}MB (${percentage}%)`);
                
                if (percentage > 80) {
                    document.getElementById('storageWarningText').textContent = 
                        `Armazenamento quase cheio: ${percentage}% utilizado`;
                    document.getElementById('storageWarning').classList.add('show');
                } else {
                    document.getElementById('storageWarning').classList.remove('show');
                }
                
                return { usageMB, quotaMB, percentage };
            } catch (error) {
                console.error('Erro ao verificar uso:', error);
                return null;
            }
        }

        function clearIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB n√£o inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => {
                    console.log('üóëÔ∏è IndexedDB limpo com sucesso');
                    tools = [];
                    resolve(true);
                };

                request.onerror = (event) => {
                    reject('Erro ao limpar IndexedDB: ' + event.target.error);
                };
            });
        }

        // ============================================
        // FUN√á√ïES DE SINCRONIZA√á√ÉO CORRIGIDAS
        // ============================================
        async function fetchAllFromSupabase() {
            try {
                if (!supabaseClient) {
                    showNotification('N√£o conectado √† nuvem', 'warning');
                    return { success: false, count: 0, total: 0 };
                }
                
                showLoader(true);
                showNotification('Buscando todos os itens...', 'warning');
                
                console.log('üîÑ Buscando TODOS os itens do Supabase...');
                
                // 1. CONTAR TOTAL DE ITENS
                const { count, error: countError } = await supabaseClient
                    .from('tools')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    console.error('‚ùå Erro ao contar itens:', countError);
                    showNotification('Erro ao contar itens', 'error');
                    return { success: false, count: 0, total: 0 };
                }
                
                totalToolsInDB = count || 0;
                console.log(`üìä Total de itens no banco: ${totalToolsInDB}`);
                
                if (totalToolsInDB === 0) {
                    showNotification('Nenhum item encontrado na nuvem', 'warning');
                    return { success: false, count: 0, total: 0 };
                }
                
                // 2. BUSCAR EM P√ÅGINAS
                const BATCH_SIZE = 1000;
                let allTools = [];
                let currentPage = 0;
                
                showNotification(`Buscando ${totalToolsInDB} itens...`, 'warning');
                
                while (allTools.length < totalToolsInDB) {
                    console.log(`üì• Buscando p√°gina ${currentPage + 1}...`);
                    
                    const { data, error } = await supabaseClient
                        .from('tools')
                        .select('*')
                        .range(currentPage * BATCH_SIZE, (currentPage * BATCH_SIZE) + BATCH_SIZE - 1)
                        .order('id', { ascending: true });
                    
                    if (error) {
                        throw error;
                    }
                    
                    if (data && data.length > 0) {
                        allTools = [...allTools, ...data];
                        console.log(`üì¶ P√°gina ${currentPage + 1}: ${data.length} itens (Total: ${allTools.length}/${totalToolsInDB})`);
                        
                        // Atualizar progresso
                        const progress = Math.round((allTools.length / totalToolsInDB) * 100);
                        showNotification(`Progresso: ${progress}% (${allTools.length}/${totalToolsInDB})`, 'info');
                        
                        currentPage++;
                        
                        // Pequena pausa
                        if (allTools.length < totalToolsInDB) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    } else {
                        break;
                    }
                }
                
                console.log(`‚úÖ Total recebido: ${allTools.length} itens`);
                
                if (allTools.length === 0) {
                    showNotification('Nenhum item encontrado', 'warning');
                    return { success: false, count: 0, total: 0 };
                }
                
                // 3. CONVERTER E SALVAR
                const convertedTools = allTools.map(item => ({
                    id: item.id,
                    name: item.name,
                    code: item.code,
                    patrimonio: item.patrimonio,
                    ncm: item.ncm,
                    category: item.category,
                    status: item.status,
                    location: item.location,
                    condition: item.condition,
                    notaFiscal: item.nota_fiscal,
                    unidade: item.unidade,
                    preco: item.preco,
                    quantidade: item.quantidade,
                    estoqueMinimo: item.estoque_minimo,
                    estoqueMaximo: item.estoque_maximo,
                    description: item.description,
                    observations: item.observations,
                    image: item.image_url,
                    usuarioCadastro: item.usuario_cadastro,
                    dataCadastro: item.data_cadastro,
                    createdAt: item.created_at,
                    updatedAt: item.updated_at
                }));
                
                // Salvar no IndexedDB
                await saveToIndexedDB(convertedTools);
                
                // Carregar os primeiros 100 itens na mem√≥ria
                tools = await loadFromIndexedDB(100);
                
                // Atualizar interface
                updateUI();
                
                // Salvar metadados
                localStorage.setItem('lastSync', new Date().toISOString());
                localStorage.setItem('totalItems', totalToolsInDB.toString());
                
                showNotification(`‚úÖ ${allTools.length} itens sincronizados!`, 'success');
                updateSyncInfo();
                
                return { 
                    success: true, 
                    count: allTools.length, 
                    total: totalToolsInDB 
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao sincronizar:', error);
                showNotification(`Erro: ${error.message}`, 'error');
                return { success: false, count: 0, total: 0 };
            } finally {
                showLoader(false);
            }
        }

        async function syncOnlyUpdates() {
            try {
                const lastSync = localStorage.getItem('lastSync') || '1970-01-01T00:00:00.000Z';
                console.log('üîç Buscando atualiza√ß√µes desde:', lastSync);
                
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('*')
                    .or(`created_at.gt.${lastSync},updated_at.gt.${lastSync}`)
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    console.log(`üîÑ ${data.length} itens atualizados/criados`);
                    
                    // Carregar dados atuais
                    const currentTools = await loadFromIndexedDB(999999);
                    
                    // Criar mapa
                    const toolMap = new Map();
                    currentTools.forEach(tool => toolMap.set(tool.id, tool));
                    
                    // Atualizar
                    data.forEach(newItem => {
                        const converted = {
                            id: newItem.id,
                            name: newItem.name,
                            code: newItem.code,
                            patrimonio: newItem.patrimonio,
                            ncm: newItem.ncm,
                            category: newItem.category,
                            status: newItem.status,
                            location: newItem.location,
                            condition: newItem.condition,
                            notaFiscal: newItem.nota_fiscal,
                            unidade: newItem.unidade,
                            preco: newItem.preco,
                            quantidade: newItem.quantidade,
                            estoqueMinimo: newItem.estoque_minimo,
                            estoqueMaximo: newItem.estoque_maximo,
                            description: newItem.description,
                            observations: newItem.observations,
                            image: newItem.image_url,
                            usuarioCadastro: newItem.usuario_cadastro,
                            dataCadastro: newItem.data_cadastro,
                            createdAt: newItem.created_at,
                            updatedAt: newItem.updated_at
                        };
                        toolMap.set(converted.id, converted);
                    });
                    
                    // Converter de volta
                    const updatedTools = Array.from(toolMap.values());
                    
                    // Salvar
                    await saveToIndexedDB(updatedTools);
                    
                    // Atualizar mem√≥ria
                    tools = await loadFromIndexedDB(100);
                    
                    // Atualizar √∫ltima sincroniza√ß√£o
                    localStorage.setItem('lastSync', new Date().toISOString());
                    
                    showNotification(`${data.length} atualiza√ß√µes sincronizadas!`, 'success');
                    updateUI();
                    updateSyncInfo();
                    
                    return data.length;
                }
                
                showNotification('Nenhuma atualiza√ß√£o encontrada', 'info');
                return 0;
                
            } catch (error) {
                console.error('Erro ao sincronizar atualiza√ß√µes:', error);
                showNotification('Erro ao buscar atualiza√ß√µes', 'error');
                return 0;
            }
        }

        // Fun√ß√£o de sincroniza√ß√£o padr√£o (usa a nova fun√ß√£o completa)
        async function syncFromSupabase() {
            return await fetchAllFromSupabase();
        }

        // ============================================
        // FUN√á√ïES DE INTERFACE
        // ============================================
        function updateUI() {
            // Buscar total salvo
            const totalInDB = localStorage.getItem('totalItems') || tools.length;
            
            // Atualizar contagem
            document.getElementById('totalItems').textContent = `${tools.length}/${totalInDB}`;
            document.getElementById('toolsCount').textContent = `${tools.length} de ${totalInDB} itens carregados`;
            
            // Atualizar valor total
            const totalValue = tools.reduce((sum, tool) => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                return sum + (preco * quantidade);
            }, 0);
            
            document.getElementById('totalValue').textContent = 
                `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
            
            // Atualizar estat√≠sticas
            updateStatusStats();
            updateRecentItems();
            
            // Atualizar lista se estiver na tab certa
            if (currentTab === 'catalogo') {
                updateToolsList();
            }
        }

        function updateSyncInfo() {
            const lastSync = localStorage.getItem('lastSync');
            const totalItems = localStorage.getItem('totalItems') || '?';
            const syncInfo = document.getElementById('syncInfo');
            
            if (syncInfo) {
                if (lastSync) {
                    const date = new Date(lastSync);
                    syncInfo.textContent = 
                        `√öltima: ${date.toLocaleDateString()} ${date.toLocaleTimeString()} | Total: ${totalItems} itens`;
                } else {
                    syncInfo.textContent = '√öltima sincroniza√ß√£o: Nunca';
                }
            }
        }

        function updateStatusStats() {
            const statsElement = document.getElementById('statusStats');
            if (tools.length === 0) {
                statsElement.innerHTML = '<p style="text-align: center; color: var(--gray-color);">Nenhum item</p>';
                return;
            }
            
            const stats = {};
            tools.forEach(tool => {
                stats[tool.status] = (stats[tool.status] || 0) + 1;
            });
            
            let html = '';
            const total = tools.length;
            
            for (const [status, count] of Object.entries(stats)) {
                const percent = Math.round((count / total) * 100);
                const color = getStatusColor(status);
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px;">
                            <span>${status}</span>
                            <span>${count} (${percent}%)</span>
                        </div>
                        <div style="height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            }
            
            statsElement.innerHTML = html;
        }

        function updateRecentItems() {
            const recentElement = document.getElementById('recentItems');
            const recent = tools.slice(-5).reverse();
            
            if (recent.length === 0) {
                recentElement.innerHTML = '<p style="text-align: center; color: var(--gray-color);">Nenhum item recente</p>';
                return;
            }
            
            let html = '';
            recent.forEach(tool => {
                html += `
                    <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="width: 40px; height: 40px; background: ${getStatusColor(tool.status)}20; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                            <i class="fas fa-tools" style="color: ${getStatusColor(tool.status)};"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${tool.name}</div>
                            <div style="font-size: 12px; color: var(--gray-color);">${tool.code} | ${tool.location}</div>
                        </div>
                        <div style="font-size: 14px; font-weight: 500; color: ${getStatusColor(tool.status)};">
                            ${tool.status}
                        </div>
                    </div>
                `;
            });
            
            recentElement.innerHTML = html;
        }

        function updateToolsList() {
            const listElement = document.getElementById('toolsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Carregar mais dados se necess√°rio
            if (loadedToolsCount === 0 || loadedToolsCount < tools.length) {
                loadedToolsCount = Math.min(tools.length, loadedToolsCount + 50);
            }
            
            let filteredTools = tools.slice(0, loadedToolsCount);
            
            if (searchTerm) {
                filteredTools = filteredTools.filter(tool => 
                    tool.name.toLowerCase().includes(searchTerm) ||
                    tool.code.toLowerCase().includes(searchTerm) ||
                    (tool.patrimonio && tool.patrimonio.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredTools.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 40px;">Nenhum item encontrado</p>';
                return;
            }
            
            let html = '';
            filteredTools.forEach(tool => {
                html += `
                    <div class="card" style="margin-bottom: 10px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 500; font-size: 16px;">${tool.name}</div>
                                <div style="font-size: 14px; color: var(--gray-color);">${tool.code}${tool.patrimonio ? ' | ' + tool.patrimonio : ''}</div>
                            </div>
                            <span style="font-size: 12px; padding: 4px 8px; background: ${getStatusColor(tool.status)}20; color: ${getStatusColor(tool.status)}; border-radius: 12px;">
                                ${tool.status}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">
                            <div><strong>Categoria:</strong> ${tool.category}</div>
                            <div><strong>Local:</strong> ${tool.location}</div>
                            <div><strong>Condi√ß√£o:</strong> ${tool.condition}</div>
                            <div><strong>Qtd:</strong> ${tool.quantidade}</div>
                        </div>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Dispon√≠vel': return '#27ae60';
                case 'Em Uso': return '#3498db';
                case 'Manuten√ß√£o': return '#f39c12';
                case 'Danificado': return '#e74c3c';
                default: return '#95a5a6';
            }
        }

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        async function connectToSupabase() {
            try {
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                
                // Testar conex√£o
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                updateConnectionStatus(true);
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao conectar:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const syncElement = document.getElementById('syncStatus');
            
            if (connected) {
                statusElement.textContent = 'Online';
                statusElement.style.background = 'rgba(39,174,96,0.2)';
                statusElement.style.color = '#27ae60';
                syncElement.textContent = 'Cloud';
            } else {
                statusElement.textContent = 'Offline';
                statusElement.style.background = 'rgba(231,76,60,0.2)';
                statusElement.style.color = '#e74c3c';
                syncElement.textContent = 'Local';
            }
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // INICIALIZA√á√ÉO E EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkSession();
        });

        function setupEventListeners() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
            
            // Bot√µes de sincroniza√ß√£o
            document.getElementById('syncNowBtn').addEventListener('click', async () => {
                await syncFromSupabase();
            });
            
            document.getElementById('syncAllBtn').addEventListener('click', async () => {
                if (confirm('Buscar TODOS os itens do banco de dados? Isso pode demorar.')) {
                    await fetchAllFromSupabase();
                }
            });
            
            document.getElementById('syncUpdatesBtn').addEventListener('click', async () => {
                await syncOnlyUpdates();
            });
            
            document.getElementById('clearCacheBtn').addEventListener('click', async () => {
                if (confirm('Limpar todos os dados locais?')) {
                    await clearIndexedDB();
                    tools = [];
                    updateUI();
                    showNotification('Cache limpo com sucesso', 'success');
                }
            });
            
            document.getElementById('loadMoreBtn').addEventListener('click', () => {
                updateToolsList();
            });
            
            document.getElementById('viewAllBtn').addEventListener('click', () => {
                switchTab('catalogo');
            });
            
            // Busca
            document.getElementById('searchInput').addEventListener('input', () => {
                if (currentTab === 'catalogo') {
                    updateToolsList();
                }
            });
            
            // Network
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus(true);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus(false);
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
            });
            
            document.querySelectorAll('.tab-content').forEach(div => {
                div.style.display = 'none';
            });
            
            switch(tab) {
                case 'dashboard':
                    document.getElementById('tabDashboard').style.display = 'block';
                    updateUI();
                    break;
                case 'catalogo':
                    document.getElementById('tabCatalogo').style.display = 'block';
                    loadedToolsCount = 0;
                    updateToolsList();
                    break;
                case 'scanner':
                case 'config':
                    showNotification('Funcionalidade em desenvolvimento', 'warning');
                    switchTab('dashboard');
                    break;
            }
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const users = {
                'fabio@fwcompany.com.br': {
                    password: 'FabioFW123@',
                    name: 'F√°bio Mendes',
                    role: 'dev',
                    email: 'fabio@fwcompany.com.br'
                },
                'emerson.silva@fwcompany.com.br': {
                    password: 'EmersonFW1@',
                    name: 'Emerson Silva',
                    role: 'almoxarife',
                    email: 'emerson.silva@fwcompany.com.br'
                },
                'fwuser': {
                    password: 'User123',
                    name: 'Usu√°rio',
                    role: 'user',
                    email: 'fwuser@fwcompany.com.br'
                }
            };
            
            if (users[email] && users[email].password === password) {
                currentUser = users[email];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
                initializeSystem();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mobileDashboard').style.display = 'flex';
        }

        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showDashboard();
                    setTimeout(() => initializeSystem(), 500);
                } catch (e) {
                    console.error('Erro na sess√£o:', e);
                }
            }
        }

        async function initializeSystem() {
            console.log('üîß Inicializando sistema...');
            
            try {
                // 1. Inicializar IndexedDB
                await initIndexedDB();
                
                // 2. Carregar dados do IndexedDB
                tools = await loadFromIndexedDB(100);
                console.log(`üìÅ ${tools.length} itens carregados na mem√≥ria`);
                
                // 3. Verificar total
                const savedTotal = localStorage.getItem('totalItems');
                if (savedTotal) {
                    console.log(`üìä Total registrado: ${savedTotal} itens`);
                }
                
                // 4. Conectar ao Supabase
                await connectToSupabase();
                
                // 5. Atualizar interface
                updateUI();
                updateSyncInfo();
                
                // 6. Verificar uso de armazenamento
                await checkStorageUsage();
                
                // 7. Sincroniza√ß√£o autom√°tica inteligente
                if (isOnline && supabaseClient) {
                    if (tools.length < 10) {
                        console.log('üîÑ Sincroniza√ß√£o autom√°tica (poucos dados)...');
                        setTimeout(async () => {
                            await fetchAllFromSupabase();
                        }, 1500);
                    } else {
                        console.log('üîç Buscando apenas atualiza√ß√µes...');
                        setTimeout(async () => {
                            await syncOnlyUpdates();
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                showNotification('Erro ao inicializar sistema', 'error');
            }
        }
    </script>
</body>
</html>
